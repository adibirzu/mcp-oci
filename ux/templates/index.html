<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Servers UX</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true});</script>
</head>
<body>
    <h1>MCP Servers Overview</h1>
    <nav>
        <a href="/">Servers</a> | <a href="/dashboards">Dashboards</a>
    </nav>
    
    <section class="observability">
        <h2>Observability</h2>
        <ul>
            <li>Grafana: <a href="{{ observability.grafana_url }}" target="_blank">{{ observability.grafana_url }}</a></li>
            <li>Prometheus: <a href="{{ observability.prometheus_url }}" target="_blank">{{ observability.prometheus_url }}</a></li>
            <li>Tempo (Traces API): <a href="{{ observability.tempo_url }}" target="_blank">{{ observability.tempo_url }}</a></li>
            <li>Jaeger (Trace UI): <a href="{{ observability.jaeger_url }}" target="_blank">{{ observability.jaeger_url }}</a></li>
            <li>Pyroscope (Profiling): <a href="{{ observability.pyroscope_url }}" target="_blank">{{ observability.pyroscope_url }}</a></li>
            <li>OTLP Endpoint (apps export here): <code>{{ observability.otlp_endpoint }}</code></li>
        </ul>
        <p>Tip: Use the Dashboards tab for the prebuilt MCP overview dashboard.</p>
    </section>

    <h2>MCP Architecture Diagram</h2>
    <p style="margin-bottom: 10px; color: #666; font-style: italic;">
        üí° Click on any MCP server node in the diagram below to view its tools and status
    </p>
    <div class="mermaid" id="mcp-diagram">
        {{ relations }}
    </div>
    <script>
        // Server data for interactive functionality
        const serverData = {{ servers | tojson }};

        // Error handling for Mermaid diagram
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true
            },
            securityLevel: 'loose'
        });

        // Function to toggle server tools display - must be global for Mermaid
        window.toggleServerTools = function(serverName) {
            try {

                // Clean the server name by removing any extra quotes
                const cleanedServerName = serverName.replace(/^['"]|['"]$/g, '').trim();

                // Use a more robust search method with normalization
                let server = null;
                const normalizedSearchName = cleanedServerName.toLowerCase();

                for (let i = 0; i < serverData.length; i++) {
                    const normalizedServerName = serverData[i].name.trim().toLowerCase();
                    if (normalizedServerName === normalizedSearchName) {
                        server = serverData[i];
                        break;
                    }
                }

                if (!server) {
                    return;
                }


            // Remove existing popup if any
            const existingPopup = document.getElementById('server-tools-popup');
            if (existingPopup) {
                existingPopup.remove();
            }

            // Create popup with server tools
            const popup = document.createElement('div');
            popup.id = 'server-tools-popup';
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border: 2px solid #333;
                border-radius: 8px;
                padding: 20px;
                max-width: 500px;
                max-height: 70vh;
                overflow-y: auto;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                z-index: 1000;
            `;

            let toolsHtml = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; color: #333;">${server.name}</h3>
                    <button onclick="document.getElementById('server-tools-popup').remove()"
                            style="background: #f44336; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer;">‚úï</button>
                </div>
                <p><strong>Status:</strong> <span class="status status-${server.status}">${server.status.toUpperCase()}</span></p>
                <p><strong>Port:</strong> ${server.port || 'N/A'}</p>
                <p><strong>Transport:</strong> ${server.transport}</p>
            `;

            if (server.status === 'running') {
                toolsHtml += `<p><strong>Metrics:</strong> <a href="http://localhost:${server.port}/metrics" target="_blank">View Metrics</a></p>`;
            }

            toolsHtml += '<h4>Available Tools:</h4>';
            if (server.tools && server.tools.length > 0) {
                server.tools.forEach(tool => {
                    toolsHtml += `
                        <div style="margin: 10px 0; padding: 10px; background: #f9f9f9; border-radius: 4px;">
                            <strong>${tool.name}</strong><br>
                            <small style="color: #666;">${tool.description}</small>
                        </div>
                    `;
                });
            } else {
                toolsHtml += '<p><em>No tools information available</em></p>';
            }

            popup.innerHTML = toolsHtml;
            document.body.appendChild(popup);

            // Add backdrop
            const backdrop = document.createElement('div');
            backdrop.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 999;
            `;
            backdrop.onclick = () => {
                popup.remove();
                backdrop.remove();
            };
            document.body.appendChild(backdrop);

            } catch (error) {
                console.error('Error in toggleServerTools:', error);
            }
        };

        // Handle Mermaid errors gracefully and add click listeners
        window.addEventListener('load', function() {
            try {
                mermaid.init();

                // Add fallback click listeners after Mermaid renders
                setTimeout(() => {
                    const mermaidSvg = document.querySelector('#mcp-diagram svg');
                    if (mermaidSvg) {
                        // Add click listeners to all server nodes
                        const serverNames = ['compute', 'db', 'network', 'security', 'observability', 'cost', 'inventory', 'blockstorage', 'loadbalancer', 'agents'];
                        serverNames.forEach(serverType => {
                            const node = mermaidSvg.querySelector(`[id*="${serverType}"]`);
                            if (node) {
                                node.style.cursor = 'pointer';
                                node.addEventListener('click', function() {
                                    const fullServerName = 'oci-mcp-' + serverType;
                                    toggleServerTools(fullServerName);
                                });
                            }
                        });
                    }
                }, 1000); // Wait for Mermaid to fully render

            } catch (error) {
                console.error('Mermaid diagram error:', error);
                document.getElementById('mcp-diagram').innerHTML =
                    '<p style="color: #721c24; background: #f8d7da; padding: 10px; border-radius: 4px;">‚ö†Ô∏è Diagram rendering error. Server architecture is working normally.</p>';
            }
        });
    </script>
    
    <h2>MCP Servers</h2>
    {% for server in servers %}
    <details class="server">
        <summary>
            {{ server.name }}
            <span class="status status-{{ server.status }}">{{ server.status|upper }}</span>
            {% if server.port %}(Port: {{ server.port }}){% endif %}
        </summary>
        <div class="server-details">
            <p><strong>Command:</strong> {{ server.command|join(' ') }}</p>
            <p><strong>Transport:</strong> {{ server.transport }}</p>
            <p><strong>Status:</strong>
                {% if server.status == 'running' %}‚úÖ Running - Metrics endpoint responding{% endif %}
                {% if server.status == 'stopped' %}‚ùå Stopped - No response from metrics endpoint{% endif %}
                {% if server.status == 'error' %}‚ö†Ô∏è Error - Metrics endpoint returned error{% endif %}
                {% if server.status == 'unknown' %}‚ùì Unknown - Unable to determine status{% endif %}
            </p>
            {% if server.status == 'running' %}
            <p><strong>Metrics:</strong> <a href="http://localhost:{{ server.port }}/metrics" target="_blank">http://localhost:{{ server.port }}/metrics</a></p>
            {% endif %}

            <details>
                <summary>Environment Variables</summary>
                <pre>{{ server.env|tojson(indent=2) }}</pre>
            </details>

            <details>
                <summary>Available Tools</summary>
                {% for tool in server.tools %}
                <div class="tool">
                    <h4>{{ tool.name }}</h4>
                    <p>{{ tool.description }}</p>
                    {% if tool.input_schema is defined and tool.input_schema.properties %}
                    <details>
                        <summary>Input Schema</summary>
                        <pre>{{ tool.input_schema | tojson(indent=2) }}</pre>
                    </details>
                    {% endif %}
                </div>
                {% endfor %}
            </details>
        </div>
    </details>
    {% endfor %}

    <section class="discovery">
        <h2>Discovery & Registry</h2>
        <p>The registry stores name‚ÜíOCID mappings for compartments, VCNs, subnets, instances, users, and more. It is populated by list operations and reduces API calls for subsequent name-based requests.</p>
        <h3>Coverage</h3>
        <pre>{{ registry.counts | tojson(indent=2) }}</pre>
        {% if registry.suggestions %}
        <h3>Suggestions</h3>
        <ul>
            {% for s in registry.suggestions %}<li>{{ s }}</li>{% endfor %}
        </ul>
        {% endif %}
        <h3>Shortcuts</h3>
        <ul>
            <li>Inventory: list_all_discovery ‚Äî aggregated VCNs, subnets, NSGs, instances, load balancers, Functions apps, Streams</li>
            <li>Inventory: list_streams_inventory, list_functions_applications_inventory, list_security_lists_inventory, list_load_balancers_inventory</li>
            <li>Introspect: mcp:warm:services, mcp:warm:compartment, mcp:registry:dump, mcp:registry:resolve</li>
        </ul>
    </section>
</body>
</html>
